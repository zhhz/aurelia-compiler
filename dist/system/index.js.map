{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourceRoot":"/source/","sourcesContent":["import {ViewCompiler,CompositionEngine,ViewResources,ViewSlot,ViewEngine, Container} from 'aurelia-framework';\nimport {DefaultLoader} from 'aurelia-loader-default';\nimport {TemplateRegistryEntry} from 'aurelia-loader';\nimport {ContentSelector} from 'aurelia-templating';\n\n/**\n * Compiler service\n *\n * compiles an HTML element with aurelia\n */\nexport class Compiler {\n  static inject() {return [ViewCompiler, CompositionEngine,ViewEngine, ViewResources, Container,DefaultLoader]}\n  constructor(viewCompiler, compositionEngine,viewEngine, resources, container,loader) {\n    this.viewCompiler = viewCompiler;\n    this.viewEngine = viewEngine;\n    this.compositionEngine = compositionEngine;\n    this.resources = resources;\n    this.container = container;\n    this.loader = loader;\n  }\n\n  /**\n   * Loads in a new view for a VM and swaps it with the current view in the viewslot.\n   *\n   * The transormer receives an element and should return a string.\n   */\n  swapView(container,view,transformer){\n\n    let element = container.get(Element);\n    let behavior = element.primaryBehavior;\n\n    //store the original content in a document fragment\n    if(!behavior.originalFragment) {\n      var odata = element.innerHTML;\n      if(transformer) odata = transformer(element,element.innerHTML);\n      behavior.originalFragment = this.createFragment(odata);\n      //var orignalViewFactory = behavior.behavior.originalViewFactory = this.viewCompiler.compile(behavior.originalFragment, resources);\n      //behavior.originalView = orignalViewFactory.create(container,behavior.executionContext);\n    }\n\n    return this.loadTemplate(view).then(entry=>{\n      let template = entry.template;\n\n      var data = \"\";\n      for(var i = 0, l = template.content.children.length; i < l; i++){\n        var child = template.content.children[i];\n        if(child) data += child.outerHTML;\n      }\n\n      if(transformer) data = transformer(element,data);\n\n      //apply the template , clone the nodes as this is a template that is potentially used by many VMs\n      element.innerHTML = data;\n\n      return behavior;\n    });\n  }\n\n  /**\n   * Create a fragment from an HTMLElement or String\n   *\n   * @param element {HTMLElement|String}\n   * @return {DocumentFragment}\n   */\n  createFragment(element){\n    //create a new fragment from the current content to pass to the viewCompiler\n    var fragment = document.createDocumentFragment();\n\n    var c = document.createElement(\"div\");\n    c.innerHTML = (element instanceof HTMLElement)? element.innerHTML : element;\n\n    var currentChild = c.firstChild, nextSibling;\n    while(currentChild){\n      nextSibling = currentChild.nextSibling;\n      switch(currentChild.nodeType){\n        case 1:\n          fragment.appendChild(currentChild);\n          break;\n      }\n      currentChild = nextSibling;\n    }\n\n    return fragment;\n  }\n\n  /**\n   * Create a new View from an element's innerHTML and add swap it with current viewslot contents.\n   *\n   * @param container {Container}     DI container of the VM\n   * @param ctx {executionContext}    the execution context to bind to (will use the behavior's execution context by default)\n   *\n   * @return {BehaviorInstance}   The primary behavior associated with the element\n   */\n  processBehavior(container,ctx){\n    //get current element\n    var element = container.get(Element);\n\n    var behavior = element.primaryBehavior;\n\n    //skip if element doesn't have a behavior\n    if(!behavior) return;\n    //skip if element already has a viewFactory\n    if(behavior.viewFactory) return;\n\n    behavior.isAttached = false;\n\n    //get associated viewslot and resources\n    var viewSlot = container.get(ViewSlot);\n    var resources = container.get(ViewResources);\n\n    //var viewFactory = behavior.behavior.viewFactory;\n\n    //create a new viewFactory for the current element contents\n    var fragment = this.createFragment(element);\n\n    //clear targets in the current template\n    var targets = fragment.querySelectorAll('.au-target');\n    for(var i = 0, l = targets.length; i < l; i++){\n      var target = targets[i];\n      target.classList.remove('au-target');\n    }\n\n    //create a new ViewFactory and add it to the element's behavior\n    var viewFactory = behavior.behavior.viewFactory = this.viewCompiler.compile(fragment, resources);\n\n    //empty the current contents\n    element.innerHTML = \"\";\n\n    //create a view from the template and add it to the viewslot\n    var view = viewFactory.create(container,ctx||behavior.executionContext);\n    viewSlot.add(view);\n    viewSlot.attached();\n\n    //add view to the behavior\n    behavior.view = view;\n\n    //process contentSelectors\n    ContentSelector.applySelectors(\n      {fragment:behavior.originalFragment},\n      view.contentSelectors,\n      (contentSelector, group) => contentSelector.add(group)\n    );\n    behavior.contentView = behavior.originalView;\n\n    return behavior;\n  }\n\n  /**\n   * Compile an element\n   * the element should be available in the main resource registry or\n   * in the registry of the execution context passed as the second parameter.\n   *\n   * @param element {HTMLElement}     element to compile\n   * @param ctx {Object}              execution context\n   * @param viewSlot {ViewSlot}       viewslot to add the view to (if null a new one will be created)\n   * @param templateOrFragment {HTMLTemplateElement|DocumentFragment}\n   *        specify what content to use with the element (if null the element's content will be used)\n   *\n   * @returns {ViewSlot}\n   */\n  compile(element, ctx = null,viewSlot = null,templateOrFragment=null) {\n    element.classList.remove('au-target');\n\n    if(!templateOrFragment){\n      var templateOrFragment = document.createDocumentFragment();\n      var c = document.createElement(\"div\");\n      c.innerHTML = element.innerHTML;\n      templateOrFragment.appendChild(c);\n    }\n    var view = this.viewCompiler.compile(templateOrFragment, this.resources).create(this.container, ctx);\n\n    if(!viewSlot) viewSlot = new ViewSlot(element, true);\n\n    viewSlot.add(view);\n    viewSlot.attached();\n    return viewSlot;\n  }\n\n  //------------------ Composing instructions\n\n  /**\n   * compose an alement with a new instruction\n   *\n   * @param element         an HTMLElement where the instuction will be added to.\n   * @param instruction     the instruction to process\n   * @param ctx             an exectution context\n   * @returns {*}\n   */\n  composeElementInstruction(element,instruction,ctx) {\n    instruction.viewSlot = instruction.viewSlot ||new ViewSlot(element, true,ctx);\n    return this.processInstruction(ctx,instruction);\n  }\n\n  /**\n   * compose an existing behaviour with a new instruction\n   *\n   * @param container       the DI container of the behavior (the instruction will be added to it's element)\n   * @param instruction     the instruction to process\n   * @param ctx             the exectution context\n   * @returns {*}\n   */\n  composeBehaviorInstruction(container,instruction,ctx) {\n\n    //get current element\n    var element = container.get(Element);\n\n    var behavior = element.primaryBehavior;\n\n    element.innerHTML = \"\";\n\n    //skip if element doesn't have a behavior\n    if(!behavior) return;\n    var viewSlot = container.get(ViewSlot);\n\n    instruction.viewSlot = viewSlot;\n    instruction.viewModel = behavior;\n    var context = ctx||container.executionContext;\n    instruction.executionContext = context;\n\n    return this.processInstruction(context,instruction).then(viewFactory=>{\n      behavior.behavior.viewFactory = viewFactory;\n      viewSlot.bind(context)\n    });\n  }\n\n  //------------------ Loading helpers\n\n  /**\n   * Load a moduleId as plain text\n   *\n   * @param url      path to a view file\n   * @returns {String}\n   */\n  loadText(url){\n    return this.loader.loadText(url);\n  }\n\n  /**\n   * Load a moduleId as a view factory\n   *\n   * @param view      path to a view file\n   * @returns {ViewFactory}\n   */\n  loadViewFactory(view){\n    return this.viewEngine.loadViewFactory(view);\n  }\n\n  /**\n   * Load a template and return a view registry entry\n   *\n   * @param urlOrRegistryEntry\n   * @param associatedModuleId\n   * @returns {viewRegistryEntry}\n   */\n  loadTemplate(urlOrRegistryEntry, associatedModuleId){\n    return ensureRegistryEntry(this.loader, urlOrRegistryEntry).then(viewRegistryEntry => {\n      if(viewRegistryEntry.isReady){\n        return viewRegistryEntry.factory;\n      }\n\n      return this.viewEngine.loadTemplateResources(viewRegistryEntry, associatedModuleId).then(resources => {\n        if(viewRegistryEntry.isReady){\n          return viewRegistryEntry.factory;\n        }\n\n        viewRegistryEntry.setResources(resources);\n\n        return viewRegistryEntry;\n      });\n    });\n  }\n\n  /**\n   * Loads in View and View Model resources and returns the registry entry for the VM\n   *\n   * @param moduleId\n   * @returns {Promise} return a registry entry\n   */\n  loadVM(moduleId){\n    var entry = this.loader.moduleRegistry[moduleId];\n    if(!entry){\n      return this.viewEngine.importViewResources([moduleId], [], this.resources).then(resources=>{\n        return this.viewEngine.importViewModelResource(moduleId);\n      });\n    }else{\n      return Promise.resolve(entry);\n    }\n  }\n\n  /**\n   * Process an instruction\n   * @param ctx\n   * @param instruction\n   * @returns {*}\n   */\n  processInstruction(ctx, instruction){\n\n    instruction.container = instruction.container||ctx.container||this.container;\n    instruction.executionContext = instruction.executionContext||ctx||this.executionContext;\n    instruction.viewSlot = instruction.viewSlot||ctx.viewSlot||this.viewSlot;\n    instruction.viewResources = instruction.viewResources||ctx.viewResources||this.viewResources;\n    instruction.currentBehavior = instruction.currentBehavior||ctx.currentBehavior||this.currentBehavior;\n\n    return this.compositionEngine.compose(instruction).then(next => {\n      ctx.currentBehavior = next;\n      ctx.currentViewModel = next ? next.executionContext : null;\n    });\n  }\n\n}\n\nfunction ensureRegistryEntry(loader, urlOrRegistryEntry){\n  if(urlOrRegistryEntry instanceof TemplateRegistryEntry){\n    return Promise.resolve(urlOrRegistryEntry);\n  }\n\n  return loader.loadTemplate(urlOrRegistryEntry);\n}\n"]}